name: pyindex
on:
  workflow_dispatch:
  repository_dispatch:
    types: [refresh_index]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
    - uses: actions/github-script@v8
      with:
        script: |
          const fs = require("node:fs");

          const PACKAGE_NAME = "vision-toolkit";
          const DIR = "site";

          const owner = '${{ github.repository_owner }}';
          const repo = "vision-toolkit";

          class ToHTMLSimpleIndex {
              constructor(buffer) {
                this.buffer = buffer;
              }

              dump(release_assets) {
                this.buffer.write("<HTML>\n<BODY>\n");
                for(const release_asset of release_assets) {
                    this.release_asset(release_asset);
                }
                this.buffer.write("</BODY>\n</HTML>\n");
              }

              release_asset({browser_download_url, digest}) {
              const split_download_url = browser_download_url.split("/");
              const filename = decodeURIComponent(split_download_url[split_download_url.length - 1]);

               if (! filename.endsWith(".whl")) {
                 return;
               }

               const url = `${browser_download_url}#${digest.replace(":", "=")}`;


               this.buffer.write(`<A href="${url}">${filename}</A>\n`);
              }
          }

          fs.mkdirSync(`${DIR}/${PACKAGE_NAME}`, {recursive: true});

          fs.createWriteStream(`${DIR}/index.html`)
             .write(`<HTML>\n<BODY>\n<A href="${PACKAGE_NAME}">${PACKAGE_NAME}</A>\n</BODY>\n</HTML>`);

          const to_html_index = new ToHTMLSimpleIndex(fs.createWriteStream(`${DIR}/${PACKAGE_NAME}/index.html`));

          const all_release_assets = (await github.rest.repos.listReleases({owner, repo})).data.flatMap(({assets}) => assets);
          to_html_index.dump(all_release_assets);

    - uses: actions/upload-pages-artifact@v3
      with:
        path: site/
  
      